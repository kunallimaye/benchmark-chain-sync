# =============================================================================
# Benchmark VMs - Standalone Module
# =============================================================================
# Provisions benchmark VMs from config.toml configuration.
# Each VM is created from a golden snapshot for fast provisioning.
#
# This module expects a JSON file with VM configurations generated from config.toml
# by Cloud Build before running terraform apply.
# =============================================================================

# -----------------------------------------------------------------------------
# Load VM configurations from JSON file (generated from config.toml)
# -----------------------------------------------------------------------------
locals {
  # Load VM configs from JSON file (generated by Cloud Build from config.toml)
  vm_configs = jsondecode(file("${path.module}/vms.json"))

  # Common labels for all resources
  common_labels = {
    managed-by = "terraform"
    component  = "benchmark"
  }
}

# -----------------------------------------------------------------------------
# Benchmark VM instances
# -----------------------------------------------------------------------------
module "vm" {
  source   = "./modules/vm"
  for_each = { for vm in local.vm_configs : vm.name => vm }

  name                   = each.value.name
  project_id             = var.project_id
  zone                   = each.value.zone
  machine_type           = each.value.machine_type
  network                = var.network
  storage_type           = lookup(each.value, "storage_type", null)
  disk_size_gb           = lookup(each.value, "disk_size_gb", 15000)
  provisioned_iops       = lookup(each.value, "provisioned_iops", null)
  provisioned_throughput = lookup(each.value, "provisioned_throughput", null)
  reth_version           = var.reth_version
  service_account_email  = var.service_account_email
  confidential_compute   = lookup(each.value, "confidential_compute", false)
  snapshot_name          = var.snapshot_name
  snapshot_disk_size_gb  = var.snapshot_disk_size_gb
  mount_point            = "/mnt/data"

  labels = merge(local.common_labels, {
    vm-name = each.value.name
  })
}
