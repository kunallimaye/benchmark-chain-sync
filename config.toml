# =============================================================================
# op-reth Benchmark Configuration
# =============================================================================
# This file defines the infrastructure and VM configuration for benchmarks.
# Secrets (L1_API_KEY) should be stored in .env (see .env.example).
# =============================================================================

[project]
project_id = "bct-prod-c3-tdx-3"
region = "us-central1"
zone = "us-central1-a"
network = "default"
gcs_bucket = "base-mainnet-snapshot"
chain_network = "base-mainnet"  # Blockchain network: base-mainnet or base-sepolia

[l1]
rpc_endpoint = "https://json-rpc.canwswf5ohsfgrgr5coh6xisi.blockchainnodeengine.com"
beacon_endpoint = "https://beacon.canwswf5ohsfgrgr5coh6xisi.blockchainnodeengine.com"

[build]
reth_repo = "https://github.com/paradigmxyz/reth.git"
reth_branch = "main"
op_node_version = "v1.16.5"

# -----------------------------------------------------------------------------
# Tracing Configuration
# -----------------------------------------------------------------------------
# OpenTelemetry tracing settings for Cloud Trace integration.
# Traces help identify bottlenecks in block execution and state root computation.
# Only op-reth supports OTLP tracing; op-node does not have this capability.
# -----------------------------------------------------------------------------
[tracing]
enabled = true
sample_ratio = 0.01     # 1% of traces (0.0 to 1.0)
filter = "info"         # Trace filter level: trace, debug, info, warn, error

# -----------------------------------------------------------------------------
# VM Defaults
# -----------------------------------------------------------------------------
# Defaults for [[vm]] sections. Only [defaults.vm] is supported.
# Values here are used when not specified in a [[vm]] section.
# -----------------------------------------------------------------------------
[defaults.vm]
disk_size_gb = 15000
machine_type = "c3-standard-44"
storage_type = "pd-balanced"
confidential_compute = true  # Enable TDX confidential compute
reth_version = "6df249c"

# Node mode: "archive" (keep all history) or "full" (prune to last ~10K blocks)
# Use "full" with pruned snapshots for smaller disk footprint and faster sync.
# NOTE: Node mode cannot be changed after initial sync.
node_mode = "full"

# Performance tuning (for faster sync)
# engine_cache_mb: Cross-block cache size in MB (default: 4096). Larger = more state in memory.
# engine_workers: State root worker threads. Recommend: set to vCPU count for max parallelism.
engine_cache_mb = 16384          # 16GB cross-block cache
engine_workers = 44              # Set to vCPU count (c3-standard-44 = 44 vCPUs)

# -----------------------------------------------------------------------------
# VM Instances
# -----------------------------------------------------------------------------
# Each [[vm]] defines a benchmark instance to provision.
# Required fields: name
# Optional fields: machine_type, storage_type, disk_size_gb, confidential_compute,
#                  reth_version, engine_cache_mb, engine_workers,
#                  provisioned_iops, provisioned_throughput (for Hyperdisk)
# All optional fields inherit from [defaults.vm] if not specified.
#
# NOTE: All VMs were deleted during infrastructure refactoring (2026-02-01).
# Add new VM definitions here when ready to provision.
# -----------------------------------------------------------------------------

[[vm]]
name = "op-reth-c3-standard-44-lssd-notdx"
machine_type = "c3-standard-44-lssd"
confidential_compute = false
engine_cache_mb = 65536              # 64GB cache (176GB RAM available)
engine_workers = 44                  # Match vCPU count

[[vm]]
name = "op-reth-c3-standard-44-lssd-tdx"
machine_type = "c3-standard-44-lssd"
confidential_compute = true
engine_cache_mb = 65536              # 64GB cache (176GB RAM available)
engine_workers = 44                  # Match vCPU count

[[vm]]
name = "op-reth-c3-standard-22-pdssd-notdx"
machine_type = "c3-standard-22"
storage_type = "pd-ssd"
disk_size_gb = 3000
confidential_compute = false
engine_cache_mb = 65536              # 64GB cache (88GB RAM available)
engine_workers = 22                  # Match vCPU count

[[vm]]
name = "op-reth-c3-standard-22-pdssd-tdx"
machine_type = "c3-standard-22"
storage_type = "pd-ssd"
disk_size_gb = 3000
confidential_compute = true
engine_cache_mb = 65536              # 64GB cache (88GB RAM available)
engine_workers = 22                  # Match vCPU count

# =============================================================================
# Golden Snapshot Configuration
# =============================================================================
# Pre-extracted snapshot for fast VM provisioning. Created from a synced VM.
# New VMs create their data disk from this snapshot (~10-15 min).
# For LSSD machines, the snapshot is copied to local NVMe via rsync.
#
# Available snapshots:
#   - op-reth-golden-2026-01-28-23-14: Archive snapshot (~5TB, full history)
#   - op-reth-pruned-2026-01-31: Pruned snapshot (~1.4TB, distance=50000)
#
# Use pruned snapshot with node_mode="full" for faster benchmarks.
# =============================================================================
[snapshot]
name = "op-reth-pruned-2026-01-31"
disk_size_gb = 3000  # Pruned snapshot is smaller (3TB disk)

# =============================================================================
# Reth Configuration (Performance Tuning)
# =============================================================================
# Controls batch/commit thresholds for all pipeline stages.
# These are set to reth's default values for maximum sync performance.
# Reduce thresholds for more frequent checkpoint updates (better ETA visibility)
# at the cost of slower total sync time.
# See docs/PERFORMANCE-TUNING.md for detailed explanations.
# =============================================================================
[reth_config]
# Database settings
db_max_size_gb = 15000          # Maximum database size (15TB)
db_growth_step_mb = 4096        # Database growth increment (4GB)

# Execution stage thresholds (commits when ANY threshold is hit)
execution_max_blocks = 500000               # Blocks per batch (reth default: 500000)
execution_max_changes = 5000000             # State changes per batch (reth default: 5000000)
execution_max_cumulative_gas = 1500000000000  # Gas per batch (reth default: 1.5T)
execution_max_duration = "10m"              # Max duration per batch (reth default: 10m)

# Headers stage
headers_commit_threshold = 10000            # Blocks per commit (reth default: 10000)

# Sender Recovery stage
sender_recovery_commit_threshold = 5000000  # Transactions per commit (reth default: 5000000)

# Account Hashing stage
account_hashing_clean_threshold = 500000    # Blocks before full re-hash (reth default: 500000)
account_hashing_commit_threshold = 100000   # Entities per commit (reth default: 100000)

# Storage Hashing stage
storage_hashing_clean_threshold = 500000    # Blocks before full re-hash (reth default: 500000)
storage_hashing_commit_threshold = 100000   # Entities per commit (reth default: 100000)

# Merkle stage
merkle_incremental_threshold = 7000         # Blocks for incremental mode (reth default: 7000)
merkle_rebuild_threshold = 100000           # Blocks before full rebuild (reth default: 100000)

# Transaction Lookup stage
transaction_lookup_chunk_size = 5000000     # Transactions per chunk (reth default: 5000000)

# Index History stages
index_account_history_commit_threshold = 100000  # Blocks per commit (reth default: 100000)
index_storage_history_commit_threshold = 100000  # Blocks per commit (reth default: 100000)

# Prune stage
prune_commit_threshold = 1000000            # Entries per commit (reth default: 1000000)

# ETL (Extract, Transform, Load) settings
etl_file_size = 524288000                   # File size before flush (reth default: 500MB)


