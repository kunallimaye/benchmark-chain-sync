# =============================================================================
# op-reth Benchmark Configuration
# =============================================================================
# This file defines the infrastructure and VM configuration for benchmarks.
# Secrets (L1_API_KEY) should be stored in .env (see .env.example).
# =============================================================================

[project]
project_id = "bct-prod-c3-tdx-3"
region = "us-central1"
zone = "us-central1-a"
network = "base-mainnet"
gcs_bucket = "base-mainnet-snapshot"

[l1]
rpc_endpoint = "https://json-rpc.canwswf5ohsfgrgr5coh6xisi.blockchainnodeengine.com"
beacon_endpoint = "https://beacon.canwswf5ohsfgrgr5coh6xisi.blockchainnodeengine.com"

[build]
reth_repo = "https://github.com/paradigmxyz/reth.git"
reth_branch = "main"
op_node_version = "v1.16.5"

# -----------------------------------------------------------------------------
# Tracing Configuration
# -----------------------------------------------------------------------------
# OpenTelemetry tracing settings for Cloud Trace integration.
# Traces help identify bottlenecks in block execution and state root computation.
# Only op-reth supports OTLP tracing; op-node does not have this capability.
# -----------------------------------------------------------------------------
[tracing]
enabled = true
sample_ratio = 0.01     # 1% of traces (0.0 to 1.0)
filter = "info"         # Trace filter level: trace, debug, info, warn, error

# -----------------------------------------------------------------------------
# Snapshot Download Configuration
# -----------------------------------------------------------------------------
# Shared download disk for snapshot storage. Downloaded once, shared read-only
# across all VMs for extraction. This saves time and bandwidth.
# -----------------------------------------------------------------------------
[download]
snapshot_url = "gs://base-mainnet-snapshot/base-mainnet-reth-1768474496.tar.zst"
disk_name = "op-reth-snapshot-download"
disk_size_gb = 8000
disk_type = "pd-balanced"
downloader_machine_type = "n2-standard-8"

# -----------------------------------------------------------------------------
# VM Defaults
# -----------------------------------------------------------------------------
# Defaults for [[vm]] sections. Only [defaults.vm] is supported.
# Values here are used when not specified in a [[vm]] section.
# -----------------------------------------------------------------------------
[defaults.vm]
disk_size_gb = 15000
machine_type = "c3-standard-44"
storage_type = "pd-balanced"
confidential_compute = true  # Enable TDX confidential compute
reth_version = "6df249c"

# Performance tuning (for faster sync)
# engine_cache_mb: Cross-block cache size in MB (default: 4096). Larger = more state in memory.
# engine_workers: State root worker threads. Recommend: set to vCPU count for max parallelism.
engine_cache_mb = 16384          # 16GB cross-block cache
engine_workers = 44              # Set to vCPU count (c3-standard-44 = 44 vCPUs)

# -----------------------------------------------------------------------------
# VM Instances
# -----------------------------------------------------------------------------
# Each [[vm]] defines a benchmark instance to provision.
# Required fields: name
# Optional fields: machine_type, storage_type, disk_size_gb, confidential_compute,
#                  reth_version, engine_cache_mb, engine_workers,
#                  provisioned_iops, provisioned_throughput (for Hyperdisk)
# All optional fields inherit from [defaults.vm] if not specified.
# -----------------------------------------------------------------------------

[[vm]]
name = "op-reth-c3-standard-44-pd-balanced-with-tdx"
confidential_compute = true

[[vm]]
name = "op-reth-c3-standard-44-pd-balanced-no-tdx"
confidential_compute = false

# =============================================================================
# Reth Configuration (Performance Tuning)
# =============================================================================
# Controls execution batch size for checkpoint frequency.
# Smaller batches = more frequent checkpoint updates = better ETA visibility.
# Trade-off: ~10-15% slower total sync vs 500K default.
# See docs/PERFORMANCE-TUNING.md for detailed explanations.
# =============================================================================
[reth_config]
batch_size = 10000              # Blocks per execution batch (default: 500000)
batch_duration = "1m"           # Max duration per batch (default: 10m)
db_max_size_gb = 15000          # Maximum database size (15TB)
db_growth_step_mb = 4096        # Database growth increment (4GB)

# =============================================================================
# Golden Snapshot Configuration
# =============================================================================
# Pre-extracted snapshot for fast VM provisioning. Created from a synced VM.
# New VMs create their data disk from this snapshot (~10-15 min).
# For LSSD machines, the snapshot is copied to local NVMe via rsync.
# =============================================================================
[snapshot]
name = "op-reth-golden-2026-01-28-23-14"
disk_size_gb = 15000  # Must be >= snapshot source disk size (15TB)

# =============================================================================
# ORPHANED VMs (NOT in Terraform state - manage via gcloud CLI)
# =============================================================================
# These VMs were removed from Terraform state but are still running in GCP.
# They are NOT managed by Terraform - do NOT uncomment or they will conflict.
#
# To check status: gcloud compute instances describe <name> --zone=us-central1-a
# To delete: gcloud compute instances delete <name> --zone=us-central1-a
# To SSH: gcloud compute ssh <name> --zone=us-central1-a
# =============================================================================

# [[vm]]
# name = "op-reth-c3-standard-176-lssd"
# machine_type = "c3-standard-176-lssd"
# engine_cache_mb = 65536          # 64GB cross-block cache (704GB RAM available)
# engine_workers = 176             # 176 vCPUs

# [[vm]]
# name = "op-reth-c3-standard-176-lssd-notdx"
# machine_type = "c3-standard-176-lssd"
# confidential_compute = false
# engine_cache_mb = 65536
# engine_workers = 176
