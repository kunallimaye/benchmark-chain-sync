# =============================================================================
# Snapshot Download Role
# =============================================================================
# Sets up background snapshot download with aria2c.
# On completion, automatically starts op-reth and op-node services.
# =============================================================================

---
- name: Install aria2
  apt:
    name: aria2
    state: present
    update_cache: yes

- name: Create scripts directory
  file:
    path: /opt/scripts
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Deploy snapshot download script
  template:
    src: snapshot-download.sh.j2
    dest: /opt/scripts/snapshot-download.sh
    mode: '0755'
    owner: root
    group: root

- name: Deploy configure finish script
  template:
    src: configure-finish.sh.j2
    dest: /opt/scripts/configure-finish.sh
    mode: '0755'
    owner: root
    group: root

- name: Deploy snapshot-download service
  template:
    src: snapshot-download.service.j2
    dest: /etc/systemd/system/snapshot-download.service
    mode: '0644'

- name: Deploy configure-finish service
  template:
    src: configure-finish.service.j2
    dest: /etc/systemd/system/configure-finish.service
    mode: '0644'

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes

- name: Enable snapshot-download service
  systemd:
    name: snapshot-download.service
    enabled: yes

- name: Enable configure-finish service
  systemd:
    name: configure-finish.service
    enabled: yes

- name: Check if snapshot download already running or complete
  shell: |
    if systemctl is-active snapshot-download.service >/dev/null 2>&1; then
      echo "running"
    elif [ -f "{{ snapshot_status_file }}" ] && grep -q '"stage": "ready"' "{{ snapshot_status_file }}" 2>/dev/null; then
      echo "complete"
    elif [ -f "{{ snapshot_status_file }}" ] && grep -q '"stage": "complete"' "{{ snapshot_status_file }}" 2>/dev/null; then
      echo "downloaded"
    else
      echo "not_started"
    fi
  register: snapshot_state
  changed_when: false

- name: Display current snapshot state
  debug:
    msg: "Snapshot state: {{ snapshot_state.stdout }}"

- name: Start snapshot download service (async - don't wait for completion)
  systemd:
    name: snapshot-download.service
    state: started
  async: 10
  poll: 0
  when: snapshot_state.stdout == "not_started"

- name: Display status message
  debug:
    msg: |
      
      ============================================================
      SNAPSHOT DOWNLOAD STARTED IN BACKGROUND
      ============================================================
      
      The snapshot is downloading on the VM. This will take a while.
      Cloud Build will now exit. The VM will continue independently.
      
      Monitor progress with:
        make configure-status VM={{ vm_name }}
      
      Or SSH to the VM:
        gcloud compute ssh {{ vm_name }} --zone={{ zone | default('us-central1-a') }} \
          --command='cat {{ snapshot_status_file }}'
      
      When complete, op-reth and op-node will start automatically.
      
      Status file: {{ snapshot_status_file }}
      ============================================================
  when: snapshot_state.stdout == "not_started"

- name: Display already running message
  debug:
    msg: "Snapshot download already running. Check status with: make configure-status VM={{ vm_name }}"
  when: snapshot_state.stdout == "running"

- name: Display already complete message
  debug:
    msg: "Configuration already complete. Services should be running."
  when: snapshot_state.stdout == "complete"
