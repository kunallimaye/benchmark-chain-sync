#!/bin/bash
# =============================================================================
# Snapshot Extract Script
# =============================================================================
# Extracts snapshot from shared download disk to local data disk.
# Starts op-reth and op-node on completion.
# =============================================================================

set -euo pipefail

# Configuration
STATUS_FILE="{{ extract_status_file }}"
SNAPSHOT_FILE="{{ snapshot_file }}"
DATA_DIR="{{ op_reth_data_dir }}"
EXTRACT_TEMP_DIR="${DATA_DIR}/.extract_temp"

# Write status to JSON file
write_status() {
    local stage="$1"
    local progress="$2"
    local error="${3:-}"
    
    if [ -n "$error" ]; then
        echo "{\"stage\": \"$stage\", \"progress\": \"$progress\", \"error\": \"$error\", \"timestamp\": \"$(date -Iseconds)\"}" > "$STATUS_FILE"
    else
        echo "{\"stage\": \"$stage\", \"progress\": \"$progress\", \"timestamp\": \"$(date -Iseconds)\"}" > "$STATUS_FILE"
    fi
}

# Error handler
on_error() {
    local exit_code=$?
    write_status "failed" "unknown" "Script exited with code $exit_code"
    exit $exit_code
}
trap on_error ERR

echo "=== Starting Snapshot Extraction ==="
echo "Source: $SNAPSHOT_FILE"
echo "Target: $DATA_DIR"

# Check if already complete
if [ -f "$STATUS_FILE" ] && grep -q '"stage": "ready"' "$STATUS_FILE" 2>/dev/null; then
    echo "Extraction already complete, skipping"
    exit 0
fi

# Check if reth data already exists
if [ -d "$DATA_DIR/db" ] && [ -f "$DATA_DIR/db/mdbx.dat" ]; then
    echo "Reth database already exists at $DATA_DIR/db, skipping extraction"
    write_status "ready" "100%"
    
    # Start services
    echo "=== Starting Services ==="
    systemctl start op-reth.service op-node.service
    exit 0
fi

# Check if snapshot file exists
if [ ! -f "$SNAPSHOT_FILE" ]; then
    echo "ERROR: Snapshot file not found: $SNAPSHOT_FILE"
    write_status "failed" "0%" "Snapshot file not found"
    exit 1
fi

# Get snapshot size
SNAPSHOT_SIZE=$(stat -c%s "$SNAPSHOT_FILE" 2>/dev/null || echo "0")
SNAPSHOT_SIZE_GB=$((SNAPSHOT_SIZE / 1024 / 1024 / 1024))
echo "Snapshot size: ${SNAPSHOT_SIZE_GB}GB ($SNAPSHOT_SIZE bytes)"

# Create directories
mkdir -p "$EXTRACT_TEMP_DIR" "$DATA_DIR"
chown {{ service_user }}:{{ service_group }} "$DATA_DIR"

# =============================================================================
# Extract snapshot
# =============================================================================
echo "=== Extracting Snapshot ==="
write_status "extracting" "0%"

cd "$EXTRACT_TEMP_DIR"

# Use pv for progress monitoring
# pv -n outputs numeric progress to stderr
PV_PROGRESS_FILE="/tmp/pv_progress"
rm -f "$PV_PROGRESS_FILE"

echo "Starting extraction with progress monitoring..."
(
    pv -n "$SNAPSHOT_FILE" 2>"$PV_PROGRESS_FILE" | \
        zstd -d 2>/dev/null | \
        tar -xf - 2>&1
) &
EXTRACT_PID=$!

# Monitor progress
echo "Monitoring progress (PID: $EXTRACT_PID)..."
while kill -0 $EXTRACT_PID 2>/dev/null; do
    if [ -f "$PV_PROGRESS_FILE" ]; then
        PROGRESS=$(tail -1 "$PV_PROGRESS_FILE" 2>/dev/null || echo "0")
        if [ -n "$PROGRESS" ] && [ "$PROGRESS" != "0" ]; then
            write_status "extracting" "${PROGRESS}%"
            echo "Progress: ${PROGRESS}%"
        fi
    fi
    sleep 30
done

# Wait for extraction to finish and get exit code
wait $EXTRACT_PID
EXTRACT_EXIT=$?

if [ $EXTRACT_EXIT -ne 0 ]; then
    write_status "failed" "extraction" "Extraction exited with code $EXTRACT_EXIT"
    exit $EXTRACT_EXIT
fi

echo "=== Extraction complete ==="
write_status "extracting" "100%"

# Cleanup progress file
rm -f "$PV_PROGRESS_FILE"

# =============================================================================
# Fix extraction path and finalize
# =============================================================================
echo "=== Fixing extraction path ==="
write_status "finalizing" "fixing paths"

# Find the actual data directory (look for db/mdbx.dat)
MDBX_PATH=$(find "$EXTRACT_TEMP_DIR" -name "mdbx.dat" -path "*/db/*" 2>/dev/null | head -1)
if [ -n "$MDBX_PATH" ]; then
    # Get the parent directory of db/ which contains the actual reth data
    ACTUAL_DATA_DIR=$(dirname $(dirname "$MDBX_PATH"))
    echo "Found reth data at: $ACTUAL_DATA_DIR"
    
    # Move contents to the correct location
    if [ "$ACTUAL_DATA_DIR" != "$DATA_DIR" ]; then
        echo "Moving data from $ACTUAL_DATA_DIR to $DATA_DIR"
        # Remove any existing empty directories in DATA_DIR
        rm -rf "$DATA_DIR/db" "$DATA_DIR/static_files" "$DATA_DIR/blobstore" "$DATA_DIR/invalid_block_hooks" 2>/dev/null || true
        # Move the actual data
        mv "$ACTUAL_DATA_DIR"/* "$DATA_DIR/"
    fi
else
    echo "WARNING: Could not find mdbx.dat, assuming direct extraction worked"
    # Move everything from extract temp to data dir
    mv "$EXTRACT_TEMP_DIR"/* "$DATA_DIR/" 2>/dev/null || true
fi

# Set ownership
chown -R {{ service_user }}:{{ service_group }} "$DATA_DIR"

# Cleanup extraction directory
echo "=== Cleaning up extraction temp ==="
rm -rf "$EXTRACT_TEMP_DIR"

write_status "ready" "100%"
echo "=== Snapshot extraction complete ==="

# Show data size
echo "=== Data Size ==="
du -sh "$DATA_DIR"

# Start services
echo "=== Starting Services ==="
systemctl start op-reth.service
sleep 5
systemctl start op-node.service

echo "=== Services Started ==="
systemctl status op-reth.service --no-pager || true
systemctl status op-node.service --no-pager || true
