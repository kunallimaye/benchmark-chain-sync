---
# =============================================================================
# Common Role - Base packages and user setup
# =============================================================================

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Ensure SSH service is enabled and started
  systemd:
    name: ssh
    enabled: yes
    state: started

- name: Install required packages
  apt:
    name:
      - curl
      - wget
      - jq
      - htop
      - iotop
      - net-tools
      - aria2
      - zstd
      - pv  # For progress monitoring during streaming extraction
      - unzip
      - python3-pip
      - apt-transport-https
      - ca-certificates
      - gnupg
    state: present

- name: Check if gcloud is installed
  command: which gcloud
  register: gcloud_check
  changed_when: false
  failed_when: false

- name: Add Google Cloud SDK apt key
  shell: |
    curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
  args:
    creates: /usr/share/keyrings/cloud.google.gpg
  when: gcloud_check.rc != 0

- name: Add Google Cloud SDK apt repository
  copy:
    content: "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main"
    dest: /etc/apt/sources.list.d/google-cloud-sdk.list
    mode: '0644'
  when: gcloud_check.rc != 0

- name: Install Google Cloud CLI
  apt:
    name: google-cloud-cli
    state: present
    update_cache: yes
  when: gcloud_check.rc != 0

- name: Create service group
  group:
    name: "{{ service_group }}"
    system: yes

- name: Create service user
  user:
    name: "{{ service_user }}"
    group: "{{ service_group }}"
    system: yes
    create_home: no
    shell: /usr/sbin/nologin

- name: Create data directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ service_user }}"
    group: "{{ service_group }}"
    mode: '0755'
  loop:
    - "{{ op_reth_data_dir }}"
    - "{{ op_node_data_dir }}"

# Fix ownership for snapshot-based disks (pd-ssd, pd-balanced, hyperdisk)
# Files from snapshot retain original uid/gid - need recursive chown
# LSSD machines handle this in lssd_copy role with tar --no-same-owner
- name: Fix data directory ownership for snapshot-based disks
  shell: |
    chown -R {{ service_user }}:{{ service_group }} {{ op_reth_data_dir }}
    chown -R {{ service_user }}:{{ service_group }} {{ op_node_data_dir }}
  when: not (is_lssd_machine | default(false))
  changed_when: true

- name: Create log directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ service_user }}"
    group: "{{ service_group }}"
    mode: '0755'
  loop:
    - "{{ op_reth_log_dir }}"
    - "{{ op_node_log_dir }}"

- name: Generate JWT secret if not exists
  shell: |
    if [ ! -f "{{ jwt_secret_path }}" ]; then
      openssl rand -hex 32 > "{{ jwt_secret_path }}"
      chmod 600 "{{ jwt_secret_path }}"
      chown {{ service_user }}:{{ service_group }} "{{ jwt_secret_path }}"
      echo "created"
    else
      echo "exists"
    fi
  register: jwt_result
  changed_when: jwt_result.stdout == "created"

- name: Set mount point ownership
  file:
    path: "{{ mount_point }}"
    owner: "{{ service_user }}"
    group: "{{ service_group }}"
    mode: '0755'
    state: directory
