---
# =============================================================================
# op-reth Role - Install and configure op-reth
# =============================================================================

- name: Check if op-reth binary exists
  stat:
    path: "{{ op_reth_bin_path }}"
  register: op_reth_binary

- name: Download op-reth binary from GCS
  command: >
    gsutil cp "gs://{{ gcs_bucket }}/builds/{{ op_reth_artifact_name }}" "{{ op_reth_bin_path }}"
  when: not op_reth_binary.stat.exists

- name: Set op-reth binary permissions
  file:
    path: "{{ op_reth_bin_path }}"
    mode: '0755'
    owner: root
    group: root

- name: Verify op-reth binary
  command: "{{ op_reth_bin_path }} --version"
  register: op_reth_version
  changed_when: false

- name: Display op-reth version
  debug:
    msg: "{{ op_reth_version.stdout }}"

- name: Deploy reth.toml configuration
  template:
    src: reth.toml.j2
    dest: "{{ op_reth_data_dir }}/reth.toml"
    owner: "{{ service_user }}"
    group: "{{ service_group }}"
    mode: '0644'
  notify: Restart op-reth

- name: Deploy op-reth systemd service
  template:
    src: op-reth.service.j2
    dest: /etc/systemd/system/op-reth.service
    mode: '0644'
  register: op_reth_service_deployed

- name: Reload systemd after service deployment
  systemd:
    daemon_reload: yes
  when: op_reth_service_deployed.changed

# Only enable and start service when start_services is true
# When start_services is false, configure-finish.service will enable and start after snapshot download
- name: Enable op-reth service
  systemd:
    name: op-reth
    enabled: yes
  when: start_services | default(true)

- name: Start op-reth service
  systemd:
    name: op-reth
    state: started
  when: start_services | default(true)
