---
# =============================================================================
# op-node Role - Install and configure op-node
# =============================================================================

- name: Create op-node log directory
  file:
    path: "{{ op_node_log_dir }}"
    state: directory
    owner: "{{ service_user }}"
    group: "{{ service_group }}"
    mode: '0755'

- name: Check current op-node version
  command: "{{ op_node_bin_path }} --version"
  register: current_op_node_version
  changed_when: false
  failed_when: false

- name: Download op-node binary from GCS
  command: >
    gsutil cp "gs://{{ gcs_bucket }}/builds/{{ op_node_artifact_name }}" "{{ op_node_bin_path }}"
  when: current_op_node_version.rc != 0 or op_node_version not in current_op_node_version.stdout
  register: op_node_binary_downloaded

- name: Set op-node binary permissions
  file:
    path: "{{ op_node_bin_path }}"
    mode: '0755'
    owner: root
    group: root

- name: Verify op-node binary
  command: "{{ op_node_bin_path }} --version"
  register: op_node_version_output
  changed_when: false

- name: Display op-node version
  debug:
    msg: "{{ op_node_version_output.stdout }}"

- name: Deploy op-node systemd service
  template:
    src: op-node.service.j2
    dest: /etc/systemd/system/op-node.service
    mode: '0644'
  register: op_node_service_deployed

- name: Reload systemd after service deployment
  systemd:
    daemon_reload: yes
  when: op_node_service_deployed.changed

# Only enable and start service when start_services is true
# When start_services is false, configure-finish.service will enable and start after snapshot download
- name: Enable op-node service
  systemd:
    name: op-node
    enabled: yes
  when: start_services | default(true)

- name: Start op-node service
  systemd:
    name: op-node
    state: started
  when: start_services | default(true)

- name: Restart op-node if binary was updated
  systemd:
    name: op-node
    state: restarted
  when: 
    - start_services | default(true)
    - op_node_binary_downloaded.changed | default(false)
