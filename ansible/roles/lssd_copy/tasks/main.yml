---
# =============================================================================
# LSSD Copy Role - Copy data from temp snapshot disk to LSSD RAID
# =============================================================================
# This role is only executed on LSSD machines where we can't create a disk
# directly from snapshot. Instead, we:
# 1. Mount a temp pd-balanced disk created from the golden snapshot
# 2. Copy data using parallel dd + tar for maximum throughput
# 3. The temp disk is deleted by Cloud Build after Ansible completes
#
# Performance: ~590 MB/s (disk-limited) vs ~150 MB/s with rsync
# Time for 8TB: ~3 hours vs 15+ hours with rsync
# =============================================================================

- name: Check if data already exists on LSSD
  shell: test -f "{{ mount_point }}/op-reth/db/mdbx.dat"
  register: lssd_db_exists
  failed_when: false
  changed_when: false

- name: Skip copy if data already exists
  debug:
    msg: "Database already exists on LSSD - skipping copy"
  when: lssd_db_exists.rc == 0

- name: Copy data from snapshot disk to LSSD
  when: lssd_db_exists.rc != 0
  block:
    - name: Wait for snapshot disk device
      wait_for:
        path: "{{ snapshot_disk_device }}"
        timeout: 120
      register: snapshot_disk_wait

    - name: Create snapshot mount point
      file:
        path: "{{ snapshot_mount_point }}"
        state: directory
        mode: '0755'

    - name: Mount snapshot disk read-only
      mount:
        path: "{{ snapshot_mount_point }}"
        src: "{{ snapshot_disk_device }}"
        fstype: xfs
        opts: ro
        state: mounted

    - name: Display copy information
      debug:
        msg: |
          ============================================================
          LSSD DATA COPY (dd + tar parallel copy)
          ============================================================
          Source: {{ snapshot_mount_point }}
          Destination: {{ mount_point }}
          
          Using parallel copy for maximum throughput:
          - dd + pv: mdbx.dat (~1.3TB for pruned snapshot)
          - tar: all other files (~300GB)
          
          Expected time: ~30-45 min (limited by source disk read speed)
          ============================================================

    - name: Ensure database directory exists
      file:
        path: "{{ mount_point }}/op-reth/db"
        state: directory
        owner: "{{ service_user }}"
        group: "{{ service_group }}"
        mode: '0755'

    # Copy mdbx.dat with pv (async - runs in background)
    # This is the largest file (~5.5TB) and benefits from direct streaming
    - name: Copy mdbx.dat using pv (background)
      shell: |
        pv {{ mdbx_source }} > {{ mdbx_dest }} && \
        chown {{ service_user }}:{{ service_group }} {{ mdbx_dest }}
      async: 14400  # 4 hour timeout
      poll: 0
      register: dd_job

    # Copy all other files with tar (foreground)
    # --no-same-owner: extracts files owned by current user (root) rather than
    # preserving original ownership. Ownership is fixed in site.yml post_tasks.
    - name: Copy remaining files using tar
      shell: |
        cd {{ snapshot_mount_point }} && \
        tar --exclude='op-reth/db/mdbx.dat' -cf - . | (cd {{ mount_point }} && tar xf - --no-same-owner)
      async: 7200  # 2 hour timeout
      poll: 30

    - name: Display tar complete message
      debug:
        msg: "tar copy completed - waiting for mdbx.dat copy to finish..."

    # Wait for mdbx.dat copy to complete
    - name: Wait for mdbx.dat copy to complete
      async_status:
        jid: "{{ dd_job.ansible_job_id }}"
      register: dd_result
      until: dd_result.finished
      retries: 240  # 4 hours at 1 min intervals
      delay: 60

    - name: Display dd result
      debug:
        msg: "mdbx.dat copy completed successfully"

    # Note: Ownership is fixed by the op_reth role, not here.
    # This ensures consistent behavior whether data comes from snapshot copy or other sources.

    - name: Unmount snapshot disk
      mount:
        path: "{{ snapshot_mount_point }}"
        state: unmounted

    - name: Remove snapshot mount point
      file:
        path: "{{ snapshot_mount_point }}"
        state: absent

- name: Verify data on LSSD
  shell: test -f "{{ mount_point }}/op-reth/db/mdbx.dat"
  register: final_db_check
  failed_when: false
  changed_when: false

- name: Display final status
  debug:
    msg: |
      ============================================================
      LSSD COPY COMPLETE
      ============================================================
      Database exists: {{ final_db_check.rc == 0 }}
      Location: {{ mount_point }}/op-reth/db/
      ============================================================
