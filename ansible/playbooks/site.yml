---
# =============================================================================
# Full VM Setup Playbook
# =============================================================================
# Configures the benchmark VM with all required components:
# - Common packages and user setup
# - GCP Ops Agent for metrics
# - System tuning (sysctl, I/O scheduler, THP, mount options)
# - Install op-reth and op-node (binaries + systemd units)
# - Deploy reth.toml configuration
# - For LSSD machines: copy data from temp snapshot disk via rsync
# - For persistent disks: data is already present (created from snapshot)
# - Start op-reth and op-node services
#
# Safety Features:
# - Roles check if services are running before making changes
# - If config changes on running service, playbook FAILS (requires FORCE)
# - Use: make configure FORCE=true to allow restarts
# =============================================================================

- name: Setup benchmark VM
  hosts: all
  become: yes
  vars_files:
    - ../group_vars/all.yml

  pre_tasks:
    - name: Wait for cloud-init to complete
      command: cloud-init status --wait
      changed_when: false
      ignore_errors: yes

    - name: Wait for apt lock to be released
      shell: while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done
      changed_when: false

  roles:
    - common
    - ops_agent
    - system_tuning
    # LSSD machines need to copy data from temp snapshot disk BEFORE service setup
    # This must run before op_reth so data is in place when the service is configured
    - role: lssd_copy
      when: is_lssd_machine | default(false)
    - op_reth
    - op_node

  post_tasks:
    # Fix ownership of data directories before starting services
    # Handles both:
    # - Snapshot-based disks: files retain original uid/gid from snapshot
    # - LSSD machines: tar extracts files as root (running user)
    - name: Fix ownership of data directories
      shell: |
        chown -R {{ service_user }}:{{ service_group }} {{ op_reth_data_dir }}
        chown -R {{ service_user }}:{{ service_group }} {{ op_node_data_dir }}
      changed_when: true

    # Start services if not already running
    # state: started is idempotent - no-op if already running
    - name: Start op-reth service (if not already running)
      systemd:
        name: op-reth
        state: started
        enabled: yes

    - name: Start op-node service (if not already running)
      systemd:
        name: op-node
        state: started
        enabled: yes

    - name: Display configuration summary
      debug:
        msg: |
          ============================================================
          CONFIGURATION COMPLETE
          ============================================================
          
          VM: {{ vm_name }}
          Machine type: {{ machine_type }}
          Storage type: {{ storage_type }}
          LSSD machine: {{ is_lssd_machine | default(false) }}
          Confidential compute (TDX): {{ confidential_compute | default(true) }}
          
          Services:
            - op-reth: {{ 'already running' if op_reth_running.rc == 0 else 'started' }}
            - op-node: {{ 'already running' if op_node_running.rc == 0 else 'started' }}
          
          Data location: {{ mount_point }}/op-reth/
          
          Monitor sync progress:
            curl -s http://localhost:9001/metrics | grep reth_sync_checkpoint
          
          ============================================================
