---
# =============================================================================
# Full VM Setup Playbook
# =============================================================================
# Configures the benchmark VM with all required components:
# - Common packages and user setup
# - GCP Ops Agent for metrics
# - Install op-reth and op-node (binaries + systemd units)
# - For LSSD machines: copy data from temp snapshot disk via rsync
# - For persistent disks: data is already present (created from snapshot)
# - Start op-reth and op-node services
# =============================================================================

- name: Setup benchmark VM
  hosts: all
  become: yes
  vars_files:
    - ../group_vars/all.yml

  pre_tasks:
    - name: Wait for cloud-init to complete
      command: cloud-init status --wait
      changed_when: false
      ignore_errors: yes

    - name: Wait for apt lock to be released
      shell: while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done
      changed_when: false

    - name: Check if database already exists
      stat:
        path: "{{ mount_point }}/op-reth/db/mdbx.dat"
      register: reth_db_exists

  roles:
    - common
    - ops_agent
    - role: op_reth
      vars:
        start_services: false
    - role: op_node
      vars:
        start_services: false
    # LSSD machines need to copy data from temp snapshot disk
    - role: lssd_copy
      when: is_lssd_machine | default(false)

  post_tasks:
    - name: Start op-reth service
      systemd:
        name: op-reth
        state: started
        enabled: yes
        daemon_reload: yes

    - name: Start op-node service
      systemd:
        name: op-node
        state: started
        enabled: yes

    - name: Display configuration summary
      debug:
        msg: |
          ============================================================
          CONFIGURATION COMPLETE
          ============================================================
          
          VM: {{ vm_name }}
          Machine type: {{ machine_type }}
          Storage type: {{ storage_type }}
          LSSD machine: {{ is_lssd_machine | default(false) }}
          Confidential compute (TDX): {{ confidential_compute | default(true) }}
          
          Services started:
            - op-reth: running
            - op-node: running
          
          Data location: {{ mount_point }}/op-reth/
          
          Monitor sync progress:
            curl -s http://localhost:9001/metrics | grep reth_sync_checkpoint
          
          ============================================================
